"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}var app=angular.module("wikiApp",["ui.bootstrap","ui.router","LocalStorageModule","ngTouch"]);app.constant("CONST",{API_URL:"https://desolate-sea-75202.herokuapp.com",INITIAL_SEARCH_RAD:"10",MAX_SEARCH_RAD:"100",REFRESH_DIST:"1"}),app.constant("HELPERS",{calcDist:function(e,t){var r=2,o=69.2,n=(e["long"]-t["long"])*((180-Math.abs(e.lat))/180),i=e.lat-t.lat,c=Math.pow(n,2),l=Math.pow(i,2),s=Math.sqrt(c+l)*o;return s.toPrecision(r)}}),app.run(["UserSrvc","LoginSrvc",function(e,t){t.forceSSL(),e.locate(),t.init(e.requestMe)}]),app.config(["$stateProvider","$urlRouterProvider","localStorageServiceProvider",function(e,t,r){r.setPrefix("userApp"),e.state("main",{url:"/main?login",template:"<main-page></main-page>"}).state("resource",{url:"/resource/:resourceId",template:"<resource-page></resource-page>"}).state("list",{url:"/list",template:"<list-page></list-page>"}),t.otherwise("main")}]),app.controller("appCtrl",["$scope","CONST","UserSrvc","ResourceSrvc","LoginSrvc",function(e,t,r,o,n){n.listen("tokenChange",e,function(){u()}),r.listen("coords",e,function(){o.requestDeck(r.me,r.coords,c())}),r.listen("me",e,function(){return r.me?void o.requestDeck(r.me,r.coords,c()):n.logout()}),o.listen("deck",e,function(){i()&&a()});var i=function(){return o.deck.length<=0},c=function(){return s*t.INITIAL_SEARCH_RAD},l=function(){return c()>t.MAX_SEARCH_RAD},s=1,a=function d(){return s+=s,l()?o.stopSearch():void o.requestDeck(r.me,r.coords,c(),function(e,t){i()&&d()})},u=function(){var e=n.token;if(!e)return r.deleteMe();var t=JSON.parse(atob(e.split(".")[1]));r.requestMe(t.id)}}]),app.service("LoginSrvc",["CONST","$http","$rootScope","$state","$location","$window","localStorageService",function(e,t,r,o,n,i,c){var l=this;this.forceSSL=function(){"https"!==n.protocol()&&(i.location.href=n.absUrl().replace("http","https"))},this.logout=function(){var e=c.get("token");e&&(c.remove("token"),l.token=null,s("tokenChange")),o.go("main",{login:!0})},this.login=function(r){return t.post(e.API_URL+"/users/login",r).success(function(e){a(e)})},this.register=function(r){return t.post(e.API_URL+"/users/register",r).success(function(e){a(e)})},this.guest=function(){return t.post(e.API_URL+"/users/guest").success(function(e){a(e)})},this.listen=function(e,t,o){var n=r.$on(e,o);t.$on("$destroy",n)},this.init=function(e){if(l.token=c.get("token")||null,!l.token)return void o.go("main",{login:!0});try{var r=JSON.parse(atob(l.token.split(".")[1]))}catch(n){return o.go("main",{login:!0}),c.remove("token")}return r.exp<Date.now()/1e3?(o.go("main",{login:!0}),c.remove("token")):(t.defaults.headers.common.Authorization=l.token,window.location.hash=window.location.hash.replace(/\?.*/,""),void e(r.id))};var s=function(e){r.$emit(e)},a=function(e){l.token="Bearer "+e,c.set("token","Bearer "+e),t.defaults.headers.common.Authorization=e,s("tokenChange")}}]),app.service("ResourceSrvc",["CONST","$http","$rootScope",function(e,t,r){var o=this;this.well=null,this.deck=null,this.requestDeck=function(r,o,n,i){if(r&&o.lat&&o["long"]&&n){i=i||function(){};var l=e.API_URL+"/resources/getDeck"+("/"+n+"/"+o.lat+"/"+o["long"]),s={user:r};return t.post(l,s).success(function(e){c(e),i(null,e)}).error(function(e){console.log("error getting deck",e),i(e)})}},this.addLike=function(r,o){return i(r),o?t.post(e.API_URL+"/users/likeResource/"+r._id).error(function(e){console.log("error liking",e)}):void 0},this.addStrike=function(r,o){return i(r),o?t.post(e.API_URL+"/users/strikeResource/"+r._id).error(function(e){console.log("error striking",e)}):void 0},this.stopSearch=function(){c([{}])},this.displayErrorCard=function(e){c([e])},this.setWell=function(e){o.well=e},this.listen=function(e,t,o){var n=r.$on(e,o);t.$on("$destroy",n)};var n=function(e){r.$emit(e)},i=function(e){var t=o.deck.indexOf(e);-1!==t&&(o.deck.splice(t,1),n("deck"))},c=function(e){o.deck=e,o.well||(o.well=e[0]),n("deck")}}]),app.service("UserSrvc",["CONST","HELPERS","$http","$rootScope",function(e,t,r,o){var n=this,i=e.REFRESH_DIST;this.me=null,this.likesDistDict={},this.coords={lat:null,"long":null},this.locationWatcher=null,this.nearby=null,this.locate=function(){"geolocation"in navigator&&(navigator.geolocation.clearWatch(n.locationWatcher),n.locationWatcher=navigator.geolocation.watchPosition(function(e){d(e)>i&&(u(e),c())},function(e){console.log("couldn't find geolocation",e)}))},this.requestMe=function(t,o){o=o||function(){};var i=e.API_URL+"/users/user/"+t;return r.get(i).success(function(e){a(e),c(),o(null,e)}).error(function(e){n.deleteMe(),o(e)})},this.like=function(e,t){return n.me.likes.some(function(t){return t._id===e._id})?t(e):(n.likesDistDict[e.pageid]=l(e),n.me.likes.unshift(e),t(e,"updateDb"),void s("vote"))},this.strike=function(e,t){return n.me.strikes.some(function(t){return t===e._id})?t(e):(n.me.strikes.push(e._id),t(e,"updateDb"),void s("vote"))},this.listen=function(e,t,r){var n=o.$on(e,r);t.$on("$destroy",n)},this.deleteMe=function(){a(null)};var c=function(){n.me&&n.coords.lat&&n.me.likes.length&&(n.likesDistDict={},n.me.likes.forEach(function(e){n.likesDistDict[e.pageid]=l(e)}))},l=function(e){var r=10,o={lat:e.lat,"long":e["long"]};if(!o.lat||!o["long"]||!n.coords)return 0;var i=t.calcDist(o,n.coords),c=r>=i?(r-i)/r:0;return c},s=function(e){o.$emit(e)},a=function(e){n.me=e,s("me")},u=function(e){return e?(n.coords={lat:e.coords.latitude,"long":e.coords.longitude},void s("coords")):n.coords=null},d=function(e){if(!n.coords.lat||!n.coords["long"])return 1/0;var r={};r.lat=e.coords.latitude,r["long"]=e.coords.longitude,t.calcDist(n.coords,r)}}]),app.directive("alertBar",function(){return{restrict:"E",transclude:!0,replace:!0,controller:"alertBarCtrl",controllerAs:"ab",scope:!0,bindToController:{},templateUrl:"js/shared/alertBar/alertBar.html",link:function(e,t,r,o,n){t.append(n())}}}),app.controller("alertBarCtrl",function(){}),app.directive("cardDirective",function(){return{restrict:"A",controller:"cardCtrl",controllerAs:"cc",scope:!0,bindToController:{resource:"="},templateUrl:"js/shared/card/card.html"}}),app.controller("cardCtrl",["$scope","UserSrvc","HELPERS",function(e,t,r){var o=this;o.resourceCoords=function(){return{lat:o.resource.lat,"long":o.resource["long"]}},o.dist=function(){return r.calcDist(t.coords,o.resourceCoords())||""}}]),app.directive("deck",function(){return{restrict:"E",replace:!0,controller:"deckCtrl",controllerAs:"dc",scope:!0,bindToController:{deck:"="},templateUrl:"js/shared/deck/deck.html"}}),app.controller("deckCtrl",["$state","UserSrvc","ResourceSrvc","$timeout",function(e,t,r,o){var n=this,i=.6;n.deck=n.deck||[{}],n.movingCard=null,n.preLoad=function(){return n.deck[1]?n.deck[1].info.imgUrl:""},n.viewWell=function(t){r.well=t,e.go("resource",{resourceId:t._id})},n.like=function(e){n.movingCard||n.deck[0].pageid&&(c(),n.liked=!0,n.movingCard=angular.copy(e),t.like(e,r.addLike))},n.strike=function(e){n.movingCard||n.deck[0].pageid&&(c(),n.liked=!1,n.movingCard=angular.copy(e),t.strike(e,r.addStrike))};var c=function(){o(function(){n.movingCard=null},1e3*i)}}]),app.directive("listPage",function(){return{restrict:"E",replace:!0,controller:"listPageCtrl",controllerAs:"lp",scope:!0,bindToController:{},templateUrl:"js/shared/listPage/listPage.html"}}),app.controller("listPageCtrl",["$scope","$state","UserSrvc","ResourceSrvc","HELPERS",function(e,t,r,o,n){var i=this;i.me=r.me||{likes:[]},i.coords=r.coords.lat?r.coords:null,i.nearby=r.nearby,i.ratingScale=10,i.legend=[].concat(_toConsumableArray(Array(i.ratingScale))).map(function(e,t){return"rating"+(t+1)}),i.viewResource=function(e){o.setWell(e),t.go("resource",{resourceId:e._id})},i.sortOrder=function(e){return i.nearby?-r.likesDistDict[e.pageid]:"index"},i.ratingClass=function(e){if(i.nearby){var t=Math.ceil(i.ratingScale*r.likesDistDict[e.pageid]);return"rating"+t}},i.togNearby=function(){r.nearby=!r.nearby},r.listen("me",e,function(){i.me=r.me}),r.listen("coords",e,function(){i.coords=r.coords})}]),app.directive("loginModal",function(){return{restrict:"E",replace:!0,controller:"loginCtrl",controllerAs:"lm",scope:!0,bindToController:{},templateUrl:"js/shared/loginModal/loginModal.html"}}),app.controller("loginCtrl",["$scope","$state","LoginSrvc",function(e,t,r){var o=this;o.token=r.token,o.submitLogin=function(e){r.login(e).success(function(e){t.go("main",{login:null})}).error(function(e){o.loginAlert=e,console.log("error",e)})},o.submitRegister=function(e){r.register(e).success(function(e){t.go("main",{login:null})}).error(function(e){o.registerAlert=e,console.log("error",e)})},o.submitGuest=function(){r.guest().success(function(e){t.go("main",{login:null})}).error(function(e){o.guestAlert=e,console.log("error",e)})},o.closeLoginModal=function(){window.location.hash=window.location.hash.replace(/\?.*/,"")},o.closeLoginAlert=function(){return o.loginAlert=null},o.closeRegisterAlert=function(){return o.registerAlert=null},o.closeGuestAlert=function(){return o.guestAlert=null}}]),app.directive("mainPage",function(){return{restrict:"E",replace:!0,controller:"mainPageCtrl",controllerAs:"mp",scope:!0,bindToController:{},templateUrl:"js/shared/mainPage/mainPage.html"}}),app.controller("mainPageCtrl",["$scope","$stateParams","$timeout","ResourceSrvc","LoginSrvc","UserSrvc",function(e,t,r,o,n,i){function c(){n.token&&r(function(){i.coords.lat||o.displayErrorCard({info:{title:"We can't find you right now.",intro:"Try coming back later!",imgUrl:"http://danielryanday.com/wp-content/uploads/2013/04/waldo.png"}})},15e3)}var l=this;l.showLogin=t.login,l.deck=o.deck,o.listen("deck",e,function(){l.deck=o.deck}),n.listen("tokenChange",e,function(){c()}),c()}]),app.directive("navBar",function(){return{restrict:"E",replace:!0,controller:"navBarCtrl",controllerAs:"nb",scope:!0,bindToController:{},templateUrl:"js/shared/navBar/navBar.html"}}),app.controller("navBarCtrl",["LoginSrvc","UserSrvc","$scope","$location",function(e,t,r,o){var n=this;n.logout=function(){e.logout()},t.listen("me",r,function(){n.me=t.me}),n.me=t.me,n.guest=function(){return n.me&&"000000000000000000000000"===n.me._id.toString()},n.selected=window.location.hash.split("/")[1],window.addEventListener("hashchange",function(e){n.selected=window.location.hash.split("/")[1]})}]),app.directive("resourcePage",function(){return{restrict:"E",replace:!0,controller:"resourcePageCtrl",controllerAs:"rp",scope:!0,bindToController:{},templateUrl:"js/shared/resourcePage/resourcePage.html"}}),app.controller("resourcePageCtrl",["$scope","$sce","ResourceSrvc","UserSrvc","HELPERS",function(e,t,r,o,n){var i=this,c="https://www.wikipedia.org/";i.well=r.well,i.iframeUrl=t.trustAsResourceUrl(i.well?i.well.info.url:c);var l=function(){if(i.well){var e={lat:i.well.lat,"long":i.well["long"]};return n.calcDist(o.coords,e)||""}};i.dist=l(),o.listen("coords",e,function(){i.dist=l()})}]),app.directive("signUpBar",function(){return{restrict:"E",replace:!0,controller:"signUpBarCtrl",controllerAs:"sb",scope:!0,bindToController:{},templateUrl:"js/shared/signUpBar/signUpBar.html"}}),app.controller("signUpBarCtrl",["LoginSrvc","UserSrvc","$scope",function(e,t,r){var o=this;o.logout=function(){e.logout()},t.listen("me",r,function(){o.me=t.me}),o.me=t.me,o.guest=function(){return o.me&&"000000000000000000000000"===o.me._id.toString()}}]);